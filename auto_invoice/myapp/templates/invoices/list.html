{% extends "base.html" %}
{% block title %}Invoices | Lean Invoice{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-bold">Invoices</h1>
  <a href="{% url 'invoice_create' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">New Invoice</a>
</div>

<!-- keep visible to avoid clipping -->
<div class="bg-white rounded-2xl shadow overflow-visible">
  <table class="min-w-full table-auto">
    <thead class="bg-gray-50">
      <tr>
        <th class="text-left p-3">Number</th>
        <th class="text-left p-3">Type</th>
        <th class="text-left p-3">Customer</th>
        <th class="text-left p-3">Issue Date</th>
        <th class="text-left p-3">Due Date</th>
        <th class="text-left p-3">Status</th>
        <th class="text-left p-3 min-w-[24rem]">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for inv in invoices %}
      <tr class="border-t hover:bg-gray-50">
        <td class="p-3">
          <a href="{% url 'invoice_update' inv.pk %}" class="text-blue-700 hover:underline">{{ inv.number }}</a>
        </td>
        <td class="p-3">{{ inv.get_invoice_type_display }}</td>
        <td class="p-3">{{ inv.customer.name }}</td>
        <td class="p-3">{{ inv.issue_date }}</td>
        <td class="p-3">{{ inv.due_date }}</td>

        <td class="p-3">
          {% if inv.status == 'DRAFT' %}
            <span class="px-2 py-1 rounded text-gray-800 bg-gray-200">Draft</span>
          {% elif inv.status == 'SENT' %}
            <span class="px-2 py-1 rounded text-orange-800 bg-orange-100">Sent</span>
          {% elif inv.status == 'PAID' %}
            <span class="px-2 py-1 rounded text-green-800 bg-green-100">Paid</span>
          {% elif inv.status == 'CANCELLED' %}
            <span class="px-2 py-1 rounded text-red-800 bg-red-100">Cancelled</span>
          {% endif %}
        </td>

        <td class="p-3 overflow-visible">
          <div class="flex items-center gap-2 flex-wrap md:flex-nowrap">
            {% if inv.status == 'DRAFT' %}
              <a href="{% url 'invoice_update' inv.pk %}" class="px-3 py-1.5 text-sm rounded bg-yellow-500 text-white hover:bg-yellow-600">
                Edit
              </a>

              <form method="post" action="{% url 'invoice_cancel' inv.pk %}">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 text-sm rounded bg-red-600 text-white hover:bg-red-700">
                  Cancel
                </button>
              </form>

              <!-- FORCE VISIBILITY ON SEND -->
              <form method="post" action="{% url 'invoice_send' inv.pk %}" class="relative z-0">
                {% csrf_token %}
                <button
                  type="submit"
                  class="px-3 py-1.5 text-sm rounded !bg-blue-600 !text-white hover:!bg-blue-700
                         border border-blue-700 ring-1 ring-inset ring-blue-700/50 z-10 inline-block">
                  Send
                </button>
              </form>

            {% elif inv.status == 'SENT' %}
              <form method="post" action="{% url 'invoice_mark_paid' inv.pk %}">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 text-sm rounded bg-green-600 text-white hover:bg-green-700">
                  Mark as Paid
                </button>
              </form>

            {% elif inv.status == 'PAID' %}
              <!-- no actions -->

            {% elif inv.status == 'CANCELLED' %}
              <!-- no actions -->
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td class="p-4 text-center text-gray-500" colspan="7">No invoices yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
